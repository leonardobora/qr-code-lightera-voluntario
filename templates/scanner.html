{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <h2><i class="bi bi-qr-code-scan"></i> Scanner de QR Code</h2>
        
        <div class="card mt-4">
            <div class="card-body">
                <div id="reader" class="mb-3"></div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Como usar:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Posicione o QR code dentro da área de scanner</li>
                        <li>Aguarde a leitura automática</li>
                        <li>O sistema processará automaticamente a retirada da cesta</li>
                    </ul>
                </div>
                
                <div id="result" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
function onScanSuccess(decodedText, decodedResult) {
    // Stop scanning temporarily
    html5QrcodeScanner.pause(true);
    
    // Process the QR code
    fetch('/api/validar_qr', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            qr_content: decodedText
        })
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('result');
        
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="bi bi-check-circle"></i> ${data.message}</h5>
                    <p><strong>Funcionário:</strong> ${data.funcionario}</p>
                    <p><strong>Código:</strong> ${data.codigo}</p>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> ${data.message}
                </div>
            `;
        }
        
        // Resume scanning after 3 seconds
        setTimeout(() => {
            html5QrcodeScanner.resume();
            document.getElementById('result').innerHTML = '';
        }, 3000);
    })
    .catch(error => {
        document.getElementById('result').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Erro ao processar QR code
            </div>
        `;
        
        setTimeout(() => {
            html5QrcodeScanner.resume();
            document.getElementById('result').innerHTML = '';
        }, 3000);
    });
}

function onScanFailure(error) {
    // Handle scan failure (usually just noise, can be ignored)
}

// Initialize the QR code scanner
let html5QrcodeScanner = new Html5QrcodeScanner(
    "reader", 
    { 
        fps: 10, 
        qrbox: {width: 250, height: 250},
        aspectRatio: 1.0
    },
    false
);

html5QrcodeScanner.render(onScanSuccess, onScanFailure);
</script>
{% endblock %}