{% extends "base.html" %}

{% block title %}Scanner QR - Sistema QR Code{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/html5-qrcode"></script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-camera"></i> Scanner de QR Code</h5>
            </div>
            <div class="card-body">
                <div id="reader" style="width: 100%;"></div>
                
                <div class="mt-3">
                    <button id="start-button" class="btn btn-success me-2">
                        <i class="bi bi-play"></i> Iniciar Scanner
                    </button>
                    <button id="stop-button" class="btn btn-danger me-2" style="display: none;">
                        <i class="bi bi-stop"></i> Parar Scanner
                    </button>
                    <select id="camera-select" class="form-select" style="display: inline-block; width: auto;"></select>
                </div>
                
                <div id="manual-input" class="mt-4" style="display: none;">
                    <hr>
                    <h6>Inserir Código Manualmente</h6>
                    <div class="input-group">
                        <input type="text" id="manual-code" class="form-control" placeholder="Digite o código QR...">
                        <button class="btn btn-primary" onclick="validateManualCode()">
                            <i class="bi bi-check"></i> Validar
                        </button>
                    </div>
                </div>
                
                <button class="btn btn-link mt-2" onclick="toggleManualInput()">
                    <i class="bi bi-keyboard"></i> Inserir código manualmente
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="bi bi-info-circle"></i> Status do Scanner</h6>
            </div>
            <div class="card-body">
                <div id="scanner-status" class="alert alert-secondary">
                    <i class="bi bi-camera-video-off"></i> Scanner parado
                </div>
                
                <div id="scan-result" style="display: none;" class="alert alert-success">
                    <h6><i class="bi bi-check-circle"></i> QR Code Validado!</h6>
                    <div id="result-details"></div>
                </div>
                
                <div id="scan-error" style="display: none;" class="alert alert-danger">
                    <h6><i class="bi bi-x-circle"></i> Erro na Validação</h6>
                    <div id="error-details"></div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="bi bi-question-circle"></i> Como Usar</h6>
            </div>
            <div class="card-body">
                <ol class="small">
                    <li>Clique em "Iniciar Scanner"</li>
                    <li>Aponte a câmera para o QR code</li>
                    <li>Aguarde a leitura automática</li>
                    <li>O sistema validará automaticamente</li>
                </ol>
                
                <hr>
                
                <h6 class="small">Problemas com a câmera?</h6>
                <p class="small text-muted">
                    Use a opção "Inserir código manualmente" para digitar o código diretamente.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let html5QrcodeScanner = null;
let scanning = false;

document.getElementById('start-button').addEventListener('click', startScanner);
document.getElementById('stop-button').addEventListener('click', stopScanner);

async function startScanner() {
    try {
        const cameras = await Html5Qrcode.getCameras();
        
        if (cameras && cameras.length) {
            // Populate camera select
            const select = document.getElementById('camera-select');
            select.innerHTML = '';
            cameras.forEach((camera, index) => {
                const option = document.createElement('option');
                option.value = camera.id;
                option.text = camera.label || `Camera ${index + 1}`;
                select.appendChild(option);
            });
            
            // Start with first camera
            const cameraId = cameras[0].id;
            
            html5QrcodeScanner = new Html5Qrcode("reader");
            
            await html5QrcodeScanner.start(
                cameraId,
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                onScanSuccess,
                onScanFailure
            );
            
            scanning = true;
            updateUI();
            updateStatus('Scanner ativo - aponte para um QR code', 'success');
            
        } else {
            showError('Nenhuma câmera encontrada');
        }
    } catch (err) {
        console.error('Erro ao iniciar scanner:', err);
        showError('Erro ao acessar a câmera. Verifique as permissões.');
    }
}

async function stopScanner() {
    if (html5QrcodeScanner && scanning) {
        try {
            await html5QrcodeScanner.stop();
            html5QrcodeScanner = null;
            scanning = false;
            updateUI();
            updateStatus('Scanner parado', 'secondary');
        } catch (err) {
            console.error('Erro ao parar scanner:', err);
        }
    }
}

function onScanSuccess(decodedText, decodedResult) {
    console.log(`QR Code detectado: ${decodedText}`);
    validateQRCode(decodedText);
}

function onScanFailure(error) {
    // Ignore scan failures (too frequent)
}

async function validateQRCode(code) {
    try {
        const response = await fetch('/validate-qr', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ code: code })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message, result.data);
        } else {
            showError(result.message);
        }
        
    } catch (error) {
        console.error('Erro na validação:', error);
        showError('Erro de conexão. Tente novamente.');
    }
}

function validateManualCode() {
    const code = document.getElementById('manual-code').value.trim();
    if (code) {
        validateQRCode(code);
        document.getElementById('manual-code').value = '';
    }
}

function toggleManualInput() {
    const manual = document.getElementById('manual-input');
    manual.style.display = manual.style.display === 'none' ? 'block' : 'none';
}

function showSuccess(message, data) {
    hideResults();
    const resultDiv = document.getElementById('scan-result');
    const detailsDiv = document.getElementById('result-details');
    
    detailsDiv.innerHTML = `
        <p><strong>Categoria:</strong> ${data.category}</p>
        <p><strong>Funcionário:</strong> ${data.employee}</p>
        <p><strong>Criado em:</strong> ${data.created_at}</p>
        ${data.description ? `<p><strong>Descrição:</strong> ${data.description}</p>` : ''}
    `;
    
    resultDiv.style.display = 'block';
    
    // Auto-hide after 10 seconds
    setTimeout(() => {
        resultDiv.style.display = 'none';
    }, 10000);
}

function showError(message) {
    hideResults();
    const errorDiv = document.getElementById('scan-error');
    const detailsDiv = document.getElementById('error-details');
    
    detailsDiv.innerHTML = message;
    errorDiv.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

function hideResults() {
    document.getElementById('scan-result').style.display = 'none';
    document.getElementById('scan-error').style.display = 'none';
}

function updateStatus(message, type) {
    const statusDiv = document.getElementById('scanner-status');
    statusDiv.className = `alert alert-${type}`;
    statusDiv.innerHTML = `<i class="bi bi-camera-video${type === 'success' ? '' : '-off'}"></i> ${message}`;
}

function updateUI() {
    document.getElementById('start-button').style.display = scanning ? 'none' : 'inline-block';
    document.getElementById('stop-button').style.display = scanning ? 'inline-block' : 'none';
    document.getElementById('camera-select').style.display = scanning ? 'inline-block' : 'none';
}

// Allow Enter key on manual input
document.getElementById('manual-code').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        validateManualCode();
    }
});
</script>
{% endblock %}